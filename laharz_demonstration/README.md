# LaharZ PoC: ローカル経路平滑化（法線断面）

このデモは、既存のD8ルーティングを用いて下流へ進みながら、直近の通過セル群から「接線」を推定し、
その法線方向に断面を生成する方法を検証するものです。オリジナルのコードベースは変更しません。
PoCに関するファイルは本フォルダ内のみに置いています。

## 含まれるファイル
- `path_smoothing.py`: 移動窓（短い履歴）から接線角を推定し、法線角を計算（角速度制限含む）。
- `cross_section_angle.py`: 任意角の法線に沿ってDDAで左右へ断面を拡張する簡易ロジック（対称拡張）。
- `run_demo_local_smoothing.py`: DEMとFlowDirectionを読み込み、下流に進みつつ各ステップで断面を
  ポリラインとして出力するデモスクリプト。

## 前提条件
- ArcGIS Pro の Python 環境（Spatial Analyst 利用：ラスタ入出力・フィーチャ出力のため）
- 外部ツールは不要（本PoCは純粋にローカル処理）

## 使い方（例）
`run_demo_local_smoothing.py` の末尾にある `main()` 呼び出し例のパラメータを環境に合わせて編集するか、
Python からインポートして実行します。

```python
from run_demo_local_smoothing import main
main(
    workspace=r"C:\\Users\\...\\tokachi_laharz",
    dem_fill=r"C:\\Users\\...\\tokachi_laharz\\data_src\\tktfill",
    flow_dir_raster=r"C:\\Users\\...\\tokachi_laharz\\data_src\\tktdir",
    start_xy=(<start_x>, <start_y>),  # DEMの座標系で指定
    out_fc=r"C:\\Users\\...\\laharz_demonstration\\angle_sections.shp",
    window_len=7,
    max_delta_deg=25.0,
    max_steps=200
)
```

メモ:
- `start_xy` はDEMと同じ座標系（投影座標）で指定します。流路上のセル中心を選ぶと挙動が分かりやすいです。
- 出力をファイルGDB内のフィーチャクラスにしたい場合は、`out_fc` に既存GDB内のパスを指定してください。
- スクリプトは「各ステップの断面」を1フィーチャ（ポリライン）として書き出します。

## このPoCで確認できること
- 外部ツールに頼らないローカル経路平滑化（短い履歴窓から接線推定）
- D8の8方位に縛られない「法線角」による断面生成（蛇行部での直交性の改善）
- 幾何処理を既存本体から分離（保守・レビューのしやすさ向上）

## 制限事項（PoCの割り切り）
- 断面の停止・面積充足ロジックは簡略化しています。オリジナル `CalcCrossSection` にある
  「フィルレベル」「等値・不等値分岐」などの詳細は未実装です。
- 小規模データでの動作確認を想定しています。実運用ではベクトル化やキャッシュなどの最適化が必要になる可能性があります。
- 本PoCはオリジナルのファイル/ツールボックスを一切変更しません。

## 次のステップ
- 面積目標・標高条件（フィルレベル等）をオリジナル仕様に合わせて統合
- 同一入力に対して旧方式と新方式を自動比較するスイッチ/レポートの追加
- 希望があればツールボックス化（オリジナルと独立したツールとして提供）

---
ご不明点や、`tokachi_laharz` データに合わせた具体的な実行パラメータ例が必要であればお知らせください。
